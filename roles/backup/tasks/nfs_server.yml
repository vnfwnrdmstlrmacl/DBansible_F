---
# roles/backup/tasks/nfs_server.yml
# NFS server (storageVM): export pgBackRest repository
# NOTE: NAT 유지 환경용 - 10.2.3.0/24 + 10.2.2.0/24 모두 exports 허용

- name: Ensure this runs only on storage/backup_server hosts (storageVM)
  ansible.builtin.assert:
    that:
      - inventory_hostname in groups.get('storage', []) or inventory_hostname in groups.get('storageVM', []) or inventory_hostname in groups.get('backup_server', [])
    fail_msg: "nfs_server.yml must run only on storageVM (backup_server) hosts."

- name: Set NFS export defaults (storageVM)
  ansible.builtin.set_fact:
    _nfs_export_dir: "{{ nfs_export | default(backup_nfs_export_dir | default('/exports/pgbackrest')) }}"
    # NAT 유지 시: 서버가 클라이언트를 proxy 대역(10.2.2.0/24)로 볼 수 있으므로 둘 다 허용
    _nfs_clients_list:
      - "{{ backup_nfs_clients_cidr_db | default('10.2.3.0/24') }}"
      - "{{ backup_nfs_clients_cidr_proxy | default('10.2.2.0/24') }}"
    # 권한 모드: 기본은 랩용 0777
    _export_mode: "{{ backup_nfs_export_mode | default('0777') }}"
    _export_owner: "{{ backup_nfs_export_owner | default('postgres') }}"
    _export_group: "{{ backup_nfs_export_group | default('postgres') }}"
  changed_when: false

# ------------------------------------------------------------
# Packages
# ------------------------------------------------------------
- name: Install NFS server packages
  ansible.builtin.dnf:
    name:
      - nfs-utils
      - rpcbind
      - firewalld
    state: present

# ------------------------------------------------------------
# Services
# ------------------------------------------------------------
- name: Ensure firewalld enabled and started (storageVM)
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true

- name: Enable and start NFS services (storageVM)
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - rpcbind
    - nfs-server

# ------------------------------------------------------------
# Ensure postgres user/group exists (avoids chown/user lookup issues)
# ------------------------------------------------------------
- name: Ensure postgres group exists (storageVM)
  ansible.builtin.group:
    name: postgres
    system: true
    state: present

- name: Ensure postgres user exists (storageVM)
  ansible.builtin.user:
    name: postgres
    group: postgres
    system: true
    shell: /sbin/nologin
    create_home: false
    state: present

# ------------------------------------------------------------
# Export directory + permissions
# ------------------------------------------------------------
- name: Ensure export directory exists (storageVM)
  ansible.builtin.file:
    path: "{{ _nfs_export_dir }}"
    state: directory
    owner: "{{ _export_owner }}"
    group: "{{ _export_group }}"
    mode: "{{ _export_mode }}"

# ------------------------------------------------------------
# /etc/exports with BOTH CIDRs allowed
# ------------------------------------------------------------
- name: Render /etc/exports (storageVM) - allow DB cidr + Proxy cidr (NAT friendly)
  ansible.builtin.template:
    src: exports.j2
    dest: /etc/exports
    owner: root
    group: root
    mode: "0644"
  notify: Reload exports

# Apply immediately in same run
- name: Apply exports now (storageVM)
  ansible.builtin.command: exportfs -rav
  changed_when: false

# ------------------------------------------------------------
# Open firewall services for NFS
# ------------------------------------------------------------
- name: Open NFS related services in firewalld (storageVM)
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop:
    - nfs
    - mountd
    - rpc-bind

# Optional ICMP
- name: Allow ICMP echo-request (optional) (storageVM)
  ansible.posix.firewalld:
    rich_rule: 'rule protocol value="icmp" accept'
    permanent: true
    immediate: true
    state: enabled
  failed_when: false

# ------------------------------------------------------------
# Verification
# ------------------------------------------------------------
- name: Verify exports (storageVM)
  ansible.builtin.shell: |
    set -euo pipefail
    exportfs -v || true
    cat /etc/exports || true
  args:
    executable: /bin/bash
  changed_when: false

