---
# roles/backup/tasks/nfs_server.yml
# NFS server (backup_server: storageVM)

- name: Install NFS server packages
  ansible.builtin.dnf:
    name:
      - nfs-utils
      - rpcbind
      - firewalld
    state: present

- name: Enable and start firewalld
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true

- name: Enable and start NFS services
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - rpcbind
    - nfs-server

# (권장) storageVM에서도 postgres 유저/그룹 보장 (export dir 소유권용)
- name: Ensure postgres group exists (backup_server)
  ansible.builtin.group:
    name: postgres
    system: true
    state: present

- name: Ensure postgres user exists (backup_server)
  ansible.builtin.user:
    name: postgres
    group: postgres
    system: true
    shell: /sbin/nologin
    create_home: false
    state: present

- name: Ensure export directory exists
  ansible.builtin.file:
    path: "{{ nfs_export | default(backup_nfs_export_dir | default('/exports/pgbackrest')) }}"
    state: directory
    owner: postgres
    group: postgres
    mode: "0755"

- name: Configure /etc/exports
  ansible.builtin.template:
    src: exports.j2
    dest: /etc/exports
    mode: "0644"
  notify: Reload exports

# 핵심: NFS 포트 오픈
- name: Open NFS services in firewalld
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop:
    - nfs
    - mountd
    - rpc-bind

# (선택) ping 테스트를 위해 ICMP 허용 (public zone에서 막히는 환경 대비)
- name: Allow ICMP echo-request (optional)
  ansible.posix.firewalld:
    rich_rule: 'rule protocol value="icmp" accept'
    permanent: true
    immediate: true
    state: enabled
  failed_when: false

- name: Verify NFS port listening
  ansible.builtin.shell: |
    ss -lntp | egrep '(:2049|:111)\b' || true
    exportfs -v || true
  args:
    executable: /bin/bash
  changed_when: false

- name: Configure /etc/exports
  ansible.builtin.template:
    src: exports.j2
    dest: /etc/exports
  notify: Reload exports

