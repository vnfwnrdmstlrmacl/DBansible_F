---
# roles/backup/tasks/pgbackrest_config.yml

- name: Ensure this runs only on db_backup (dbb)
  ansible.builtin.assert:
    that:
      - inventory_hostname in groups.get('db_backup', [])
    fail_msg: "pgbackrest_config.yml must run only on db_backup (dbb)."

# ---------------------------
# SSH key for dbb -> db_cluster (root)
# ---------------------------

- name: Ensure /root/.ssh exists (dbb)
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Generate dbb ssh key if missing (ed25519)
  ansible.builtin.command: ssh-keygen -t ed25519 -a 64 -f /root/.ssh/id_ed25519 -N "" -C "dbb-pgbackrest"
  args:
    creates: /root/.ssh/id_ed25519

- name: Read dbb public key
  ansible.builtin.slurp:
    src: /root/.ssh/id_ed25519.pub
  register: dbb_pub

- name: Install dbb pubkey to db_cluster root authorized_keys (db-a/db-s)
  ansible.posix.authorized_key:
    user: root
    key: "{{ (dbb_pub.content | b64decode).strip() }}"
    state: present
    manage_dir: true
  delegate_to: "{{ item }}"
  loop: "{{ groups.get('db_cluster', []) }}"

# ---------------------------
# pgBackRest host-cmd wrapper on dbb
# (do not use template; force content)
# ---------------------------

- name: Force-install pgBackRest host-cmd wrapper on dbb (overwrite always)
  ansible.builtin.copy:
    dest: /usr/local/bin/pgbackrest_host_cmd
    owner: root
    group: root
    mode: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      SSH_BIN="/usr/bin/ssh"
      PGBIN="/usr/bin/pgbackrest"

      for a in "$@"; do
        a="${a//$'\r'/}"
        case "$a" in
          --remote-type=*|--process=*|*:remote)
            exec "${PGBIN}" "$@"
            ;;
        esac
      done

      ARGS=()
      for a in "$@"; do
        a="${a//$'\r'/}"
        if [[ "$a" == "-" || "$a" == "--" ]]; then
          continue
        fi
        ARGS+=("$a")
      done

      exec "${SSH_BIN}" -i /root/.ssh/id_ed25519 \
        -o IdentitiesOnly=yes \
        -o PreferredAuthentications=publickey \
        -o PubkeyAuthentication=yes \
        -o StrictHostKeyChecking=accept-new \
        -o UserKnownHostsFile=/root/.ssh/known_hosts \
        -o LogLevel=ERROR \
        -o ConnectTimeout=5 \
        -o ControlMaster=no \
        -o ControlPersist=no \
        "${ARGS[@]}"

# ---------------------------
# pgBackRest config + runner
# ---------------------------

- name: Ensure /etc/pgbackrest exists (dbb)
  ansible.builtin.file:
    path: /etc/pgbackrest
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Render pgBackRest config (dbb)
  ansible.builtin.template:
    src: pgbackrest.conf.j2
    dest: /etc/pgbackrest/pgbackrest.conf
    owner: root
    group: root
    mode: "0644"

- name: Install follow-primary runner script (dbb)
  ansible.builtin.template:
    src: pgbackrest_follow_primary.sh.j2
    dest: /usr/local/bin/pgbackrest_follow_primary
    owner: root
    group: root
    mode: "0755"

# ---------------------------
# Defensive normalization
# ---------------------------

- name: Strip CRLF (defensive) on dbb
  ansible.builtin.shell: |
    set -euo pipefail
    for f in /usr/local/bin/pgbackrest_host_cmd /usr/local/bin/pgbackrest_follow_primary /etc/pgbackrest/pgbackrest.conf; do
      [ -f "$f" ] && sed -i 's/\r$//' "$f"
    done
  args:
    executable: /bin/bash
  changed_when: false

