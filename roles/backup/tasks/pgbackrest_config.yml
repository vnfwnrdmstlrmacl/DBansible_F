---
- name: Ensure /root/.ssh exists (dbb)
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Assert SSH private key exists on dbb
  ansible.builtin.stat:
    path: /root/.ssh/id_ed25519
  register: _sshkey

- name: Fail if SSH key missing on dbb
  ansible.builtin.fail:
    msg: "Missing /root/.ssh/id_ed25519 on dbb. Generate/copy key first."
  when: not _sshkey.stat.exists

- name: Ensure perms on SSH key (dbb)
  ansible.builtin.file:
    path: /root/.ssh/id_ed25519
    state: file
    owner: root
    group: root
    mode: "0600"

- name: Ensure /etc/pgbackrest exists (dbb)
  ansible.builtin.file:
    path: /etc/pgbackrest
    state: directory
    owner: root
    group: root
    mode: "0755"

# -----------------------------
# Build db_cluster IP list
# -----------------------------
- name: Build db_cluster host list (inventory names)
  ansible.builtin.set_fact:
    _db_cluster_hosts: "{{ groups.get('db_cluster', []) | difference([inventory_hostname]) }}"

- name: Build db_cluster IP list
  ansible.builtin.set_fact:
    _db_cluster_ips: >-
      {{
        _db_cluster_hosts
        | map('extract', hostvars, 'ansible_host')
        | list
      }}

- name: Fail if db_cluster IP list is empty
  ansible.builtin.fail:
    msg: "db_cluster group is empty or missing ansible_host for db nodes."
  when: _db_cluster_ips | length == 0

# -----------------------------
# known_hosts (dbb): accept-new는 "변경"에는 약함 -> 매 실행마다 keyscan으로 갱신
# -----------------------------
- name: Ensure known_hosts exists (dbb)
  ansible.builtin.file:
    path: /root/.ssh/known_hosts
    state: touch
    owner: root
    group: root
    mode: "0644"

- name: Refresh known_hosts for all db_cluster nodes (dbb)
  ansible.builtin.shell: |
    set -euo pipefail
    KH="/root/.ssh/known_hosts"
    for ip in {{ _db_cluster_ips | join(' ') }}; do
      ssh-keygen -R "$ip" -f "$KH" >/dev/null 2>&1 || true
      ssh-keyscan -T 3 -H "$ip" >> "$KH" 2>/dev/null || true
    done
    chmod 0644 "$KH"
  args:
    executable: /bin/bash
  changed_when: false

# -----------------------------
# Dedicated ssh_config (dbb)
# - 여기 파일은 "dbb 로컬"에서 ssh가 참조하는 설정 파일임
# - 원격(db-a/db-s)에 배포할 필요 없음
# -----------------------------
- name: Render dedicated pgBackRest ssh_config (dbb)
  ansible.builtin.copy:
    dest: /etc/pgbackrest/ssh_config
    owner: root
    group: root
    mode: "0600"
    content: |
      # Generated by Ansible - pgBackRest dedicated SSH config (LF only)
      Host *
        User root
        IdentityFile /root/.ssh/id_ed25519
        IdentitiesOnly yes
        PreferredAuthentications publickey
        PasswordAuthentication no
        StrictHostKeyChecking accept-new
        UserKnownHostsFile /root/.ssh/known_hosts
        LogLevel ERROR
        ConnectTimeout 5
        ServerAliveInterval 10
        ServerAliveCountMax 3

- name: Strip CRLF defensively (dbb)
  ansible.builtin.shell: |
    set -euo pipefail
    sed -i 's/\r$//' /etc/pgbackrest/ssh_config
  args:
    executable: /bin/bash
  changed_when: false

# -----------------------------
# Ensure pgbackrest installed on db-a/db-s (원격에도 바이너리 있어야 check:remote가 됨)
# - 기존 에러("No match for argument: pgbackrest") 방지: EPEL + CRB 활성화 후 설치
# -----------------------------
- name: Ensure pgBackRest installed on ALL db_cluster nodes (Ansible, remote)
  block:
    - name: Install dnf-plugins-core (remote)
      ansible.builtin.dnf:
        name: dnf-plugins-core
        state: present
      become: true
      delegate_to: "{{ item }}"
      loop: "{{ _db_cluster_hosts }}"

    - name: Enable EPEL (remote)
      ansible.builtin.dnf:
        name: epel-release
        state: present
      become: true
      delegate_to: "{{ item }}"
      loop: "{{ _db_cluster_hosts }}"

    - name: Enable CRB (remote, best-effort)
      ansible.builtin.shell: |
        set -euo pipefail
        dnf config-manager --set-enabled crb || true
      args:
        executable: /bin/bash
      become: true
      delegate_to: "{{ item }}"
      loop: "{{ _db_cluster_hosts }}"
      changed_when: false

    - name: Make cache (remote)
      ansible.builtin.shell: |
        set -euo pipefail
        dnf -y makecache
      args:
        executable: /bin/bash
      become: true
      delegate_to: "{{ item }}"
      loop: "{{ _db_cluster_hosts }}"
      changed_when: false

    - name: Install pgbackrest (remote)
      ansible.builtin.dnf:
        name: pgbackrest
        state: present
      become: true
      delegate_to: "{{ item }}"
      loop: "{{ _db_cluster_hosts }}"
  rescue:
    - name: Fail with actionable message
      ansible.builtin.fail:
        msg: >
          Failed to install pgbackrest on db_cluster nodes.
          Check repo connectivity/DNS on db-a/db-s, and ensure EPEL is reachable.

# -----------------------------
# Detect primary (follow primary at configure time)
# - Patroni REST /master가 200이면 그 노드가 primary
# -----------------------------
- name: Probe Patroni /master on each db_cluster node (from dbb)
  ansible.builtin.uri:
    url: "http://{{ item }}:{{ patroni_rest_port | default(8008) }}{{ patroni_master_path | default('/master') }}"
    method: GET
    return_content: false
    timeout: 2
    status_code: [200, 503, 404, 500]
  register: _patroni_master_probe
  failed_when: false
  changed_when: false
  loop: "{{ _db_cluster_ips }}"

- name: Choose primary ip (first node returning 200 on /master)
  ansible.builtin.set_fact:
    pgbackrest_primary_ip: >-
      {{
        (
          _patroni_master_probe.results
          | selectattr('status', 'defined')
          | selectattr('status', 'equalto', 200)
          | map(attribute='item')
          | list
        )[0]
        | default(_db_cluster_ips[0])
      }}

# -----------------------------
# Render pgbackrest.conf (dbb) - wrapper 제거, 표준 방식
# -----------------------------
- name: Render pgBackRest config (dbb, wrapper-less)
  ansible.builtin.copy:
    dest: /etc/pgbackrest/pgbackrest.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      # Generated by Ansible - pgBackRest configuration (wrapper-less)

      [global]
      repo1-path={{ pgbackrest_repo_path | default('/mnt/pgbackrest') }}
      repo1-retention-full={{ retention_full | default(7) }}
      start-fast=y
      process-max={{ process_max | default(2) }}
      log-level-console=info

      [main]
      # follow primary: chosen by Patroni /master probe at deploy time
      pg1-host={{ pgbackrest_primary_ip }}
      pg1-port={{ pg_port | default(5432) }}
      pg1-path={{ patroni_pg_data_dir | default('/var/lib/pgsql/patroni') }}

      # SSH login user (OS user)
      pg1-host-user=root

      # IMPORTANT: ssh binary ONLY (no wrapper, no inline options)
      pg1-host-cmd=/usr/bin/ssh
      pg1-host-config=/etc/pgbackrest/ssh_config

      # PostgreSQL DB user on target
      pg1-user={{ pgbackrest_pg_user | default('postgres') }}

- name: Strip CRLF defensively (dbb pgbackrest.conf)
  ansible.builtin.shell: |
    set -euo pipefail
    sed -i 's/\r$//' /etc/pgbackrest/pgbackrest.conf
  args:
    executable: /bin/bash
  changed_when: false

# -----------------------------
# Preflight: raw ssh via ssh_config must work (dbb -> primary)
# -----------------------------
- name: Preflight SSH to chosen primary (dbb)
  ansible.builtin.shell: |
    set -euo pipefail
    ssh -F /etc/pgbackrest/ssh_config -o BatchMode=yes {{ pgbackrest_primary_ip }} "echo SSH_OK"
  args:
    executable: /bin/bash
  changed_when: false

# -----------------------------
# Run pgbackrest check on dbb
# -----------------------------
- name: Run pgBackRest check as root (dbb)
  ansible.builtin.command: pgbackrest --stanza=main check
  register: _pgbr_check
  changed_when: false

