---
# roles/backup/tasks/pgbackrest_install.yml
# pgBackRest 패키지 설치
#
# main.yml에서 호스트 그룹별 when으로 import_tasks 하므로 여기서는 assert로 실패시키지 않는다.

- name: Install prereqs
  ansible.builtin.dnf:
    name:
      - curl
      - ca-certificates
      - dnf-plugins-core
    state: present

- name: Enable CRB repo (best-effort)
  ansible.builtin.command: dnf config-manager --set-enabled crb
  changed_when: false
  failed_when: false

- name: Install EPEL release (best-effort)
  ansible.builtin.dnf:
    name: epel-release
    state: present
  failed_when: false

- name: Refresh dnf cache (best-effort)
  ansible.builtin.dnf:
    update_cache: true
  failed_when: false

# 1) 먼저 기본 repo/EPEL에서 시도
- name: Try install pgbackrest from current repos
  ansible.builtin.dnf:
    name: pgbackrest
    state: present
  register: _pgbr_install_try
  failed_when: false

# 2) 실패 시 PGDG repo 추가 후 재시도
- name: Install PGDG repo rpm when repo install failed
  ansible.builtin.dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
    state: present
    disable_gpg_check: true
  when: _pgbr_install_try is failed or (_pgbr_install_try.rc is defined and _pgbr_install_try.rc|int != 0)
  register: _pgdg_repo
  failed_when: false

- name: Refresh dnf cache after PGDG (best-effort)
  ansible.builtin.dnf:
    update_cache: true
  when: _pgdg_repo is changed
  failed_when: false

- name: Install pgbackrest from PGDG
  ansible.builtin.dnf:
    name: pgbackrest
    state: present
  when: _pgbr_install_try is failed or (_pgbr_install_try.rc is defined and _pgbr_install_try.rc|int != 0)
  register: _pgbr_install_final
  failed_when: false

# 3) 바이너리 존재 여부 최종 검증 (여기서만 fail)
- name: Check pgbackrest binary path
  ansible.builtin.stat:
    path: /usr/bin/pgbackrest
  register: _pgbr_bin

- name: Fail if pgbackrest still missing after install attempts
  ansible.builtin.fail:
    msg: >
      pgbackrest 설치에 실패했습니다. (CentOS Stream 9에서 repo 미구성/네트워크/DNS 문제 가능)
      dnf 결과(_pgbr_install_try, _pgbr_install_final)를 확인하세요.
  when: not _pgbr_bin.stat.exists

- name: Verify pgbackrest exists
  ansible.builtin.command: /usr/bin/pgbackrest version
  register: pgbr_ver
  changed_when: false

- name: Show pgbackrest version
  ansible.builtin.debug:
    msg: "{{ pgbr_ver.stdout | default('') }}"

