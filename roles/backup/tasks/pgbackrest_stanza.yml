---
# stanza-create는 repo(=NFS)가 마운트되어 있고, DB-A 접속이 되는 상태에서 1회 수행
# 이미 stanza가 있으면 실패할 수 있으니 idempotent 처리
- name: Check if stanza exists
  ansible.builtin.command: "pgbackrest --stanza={{ pgbackrest_stanza }} info"
  become_user: postgres
  register: stanza_info
  changed_when: false
  failed_when: false

- name: Create stanza (first time only)
  ansible.builtin.command: "pgbackrest --stanza={{ pgbackrest_stanza }} stanza-create"
  become_user: postgres
  when: stanza_info.rc != 0

