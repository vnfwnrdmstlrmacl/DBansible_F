---
# roles/backup/tasks/pgbackrest_stanza.yml
# - dbb(backup_clients)에서 root로 pgBackRest stanza-create/check 수행
# - stanza-create/check 전에 SSH/known_hosts/키 존재를 선검증해서 원인 분리

- name: Guard - run only on backup_clients
  ansible.builtin.meta: end_play
  when: inventory_hostname not in groups.get('backup_clients', [])

# ------------------------------------------------------------
# 0) 필수 패키지 / 필수 파일 존재 확인
# ------------------------------------------------------------
- name: Install openssh-clients (ssh, ssh-keyscan, ssh-keygen)
  ansible.builtin.dnf:
    name: openssh-clients
    state: present
  become: true

- name: Ensure pgBackRest config exists
  ansible.builtin.stat:
    path: /etc/pgbackrest/pgbackrest.conf
  register: pgbr_conf
  become: true

- name: Abort if pgBackRest config is missing
  ansible.builtin.fail:
    msg: "pgBackRest config not found: /etc/pgbackrest/pgbackrest.conf"
  when: not pgbr_conf.stat.exists

# ------------------------------------------------------------
# 1) root ssh 디렉토리/known_hosts 준비 (do not swallow failures)
# ------------------------------------------------------------
- name: Ensure /root/.ssh exists
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: "0700"
  become: true

- name: Ensure known_hosts file exists (root)
  ansible.builtin.file:
    path: "{{ pgbackrest_ssh_known_hosts | default('/root/.ssh/known_hosts') }}"
    state: touch
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Ensure pgBackRest SSH key exists (root)
  ansible.builtin.stat:
    path: "{{ pgbackrest_ssh_key_path | default('/root/.ssh/id_ed25519') }}"
  register: pgbr_key
  become: true

- name: Abort if pgBackRest SSH key is missing
  ansible.builtin.fail:
    msg: |
      pgBackRest SSH key not found:
      {{ pgbackrest_ssh_key_path | default('/root/.ssh/id_ed25519') }}

      This host (backup client: {{ inventory_hostname }}) must have the private key.
  when: not pgbr_key.stat.exists

- name: Preload known_hosts for Patroni nodes (strict, fail if keyscan fails)
  ansible.builtin.shell: |
    set -euo pipefail
    KH="{{ pgbackrest_ssh_known_hosts | default('/root/.ssh/known_hosts') }}"

    {% for ip in patroni_nodes | default([]) %}
    ssh-keygen -R "{{ ip }}" -f "$KH" >/dev/null 2>&1 || true
    ssh-keyscan -T 5 -H "{{ ip }}" >> "$KH"
    {% endfor %}

    sort -u "$KH" -o "$KH"
  args:
    executable: /bin/bash
  changed_when: true
  become: true

# ------------------------------------------------------------
# 2) stanza-create/check 전에 "SSH가 진짜 되는지" 선검증
#    - 여기서 실패하면 pgBackRest 문제가 아니라 "SSH 키 배포 문제"가 확정
# ------------------------------------------------------------
- name: SSH preflight to Patroni nodes (must succeed with key, BatchMode)
  ansible.builtin.command:
    argv:
      - /usr/bin/ssh
      - -i
      - "{{ pgbackrest_ssh_key_path | default('/root/.ssh/id_ed25519') }}"
      - -o
      - "IdentitiesOnly=yes"
      - -o
      - "BatchMode=yes"
      - -o
      - "StrictHostKeyChecking=yes"
      - -o
      - "UserKnownHostsFile={{ pgbackrest_ssh_known_hosts | default('/root/.ssh/known_hosts') }}"
      - -o
      - "ConnectTimeout=5"
      - "{{ (pgbackrest_pg1_host_user | default('root')) }}@{{ item }}"
      - "echo OK"
  register: ssh_preflight
  changed_when: false
  failed_when: ssh_preflight.rc != 0
  loop: "{{ patroni_nodes | default([]) }}"
  become: true

# ------------------------------------------------------------
# 3) Stanza 존재 여부 확인
# ------------------------------------------------------------
- name: Check if pgBackRest stanza already exists (info)
  ansible.builtin.command:
    argv:
      - pgbackrest
      - "--stanza={{ pgbackrest_stanza | default('main') }}"
      - info
  register: pgbr_info
  changed_when: false
  failed_when: false
  become: true

- name: Set fact - stanza_missing
  ansible.builtin.set_fact:
    stanza_missing: >-
      {{
        (pgbr_info.rc | int != 0)
        or
        ('No stanzas exist' in (pgbr_info.stdout | default('')))
        or
        ('ERROR' in (pgbr_info.stdout | default('')))
      }}

# ------------------------------------------------------------
# 4) Stanza 없을 때: stanza-create
# ------------------------------------------------------------
- name: Create pgBackRest stanza (one-time init)
  ansible.builtin.command:
    argv:
      - pgbackrest
      - "--stanza={{ pgbackrest_stanza | default('main') }}"
      - stanza-create
  register: stanza_create
  changed_when: true
  when: stanza_missing | bool
  become: true

# ------------------------------------------------------------
# 5) 검증: pgbackrest check (async)
# ------------------------------------------------------------
- name: Validate pgBackRest can reach DB and repo (pgbackrest check) [async]
  ansible.builtin.command:
    argv:
      - pgbackrest
      - "--stanza={{ pgbackrest_stanza | default('main') }}"
      - check
  register: pgbr_check_job
  async: 180
  poll: 0
  changed_when: false
  become: true

- name: Wait for pgbackrest check to finish
  ansible.builtin.async_status:
    jid: "{{ pgbr_check_job.ansible_job_id }}"
  register: pgbr_check_result
  until: pgbr_check_result.finished
  retries: 60
  delay: 3
  changed_when: false
  become: true

- name: Fail if pgbackrest check failed
  ansible.builtin.fail:
    msg: |
      pgbackrest check failed (rc={{ pgbr_check_result.rc | default('N/A') }})

      === STDOUT ===
      {{ pgbr_check_result.stdout | default('') }}

      === STDERR ===
      {{ pgbr_check_result.stderr | default('') }}

      Hint:
      - If you see "Permission denied", SSH key is not authorized on DB nodes.
      - If you see "pg1-path invalid" or "no database found", pg1-path/pg1-host is wrong.
  when: (pgbr_check_result.rc | int) != 0

