---
# roles/backup/tasks/nfs_client.yml
# NFS client mount for pgBackRest repo (dbb and other backup clients)

- name: Set NFS client defaults
  ansible.builtin.set_fact:
    _nfs_server: "{{ backup_nfs_server | default('10.2.2.30') }}"
    _nfs_export: "{{ backup_nfs_export_dir | default('/exports/pgbackrest') }}"
    _nfs_mount: "{{ pgbackrest_repo_path | default('/mnt/pgbackrest') }}"
  changed_when: false

# Ensure mount point exists (directory only, NO chown)
- name: Ensure mount point exists (client) - directory only
  ansible.builtin.file:
    path: "{{ _nfs_mount }}"
    state: directory
    mode: "0755"

# Ensure nfs-utils installed on clients
- name: Install NFS client packages
  ansible.builtin.dnf:
    name:
      - nfs-utils
    state: present

# Mount NFSv4 (idempotent)
- name: Mount NFS repo (NFSv4)
  ansible.posix.mount:
    path: "{{ _nfs_mount }}"
    src: "{{ _nfs_server }}:{{ _nfs_export }}"
    fstype: nfs4
    opts: "rw,hard,timeo=600,retrans=2,_netdev"
    state: mounted

# Verify writable (non-failing check)
- name: Verify repo is writable (client)
  ansible.builtin.shell: |
    set -euo pipefail
    touch "{{ _nfs_mount }}/.ansible_write_test" && rm -f "{{ _nfs_mount }}/.ansible_write_test"
  args:
    executable: /bin/bash
  changed_when: false

