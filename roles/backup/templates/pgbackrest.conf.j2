# Generated by Ansible - pgBackRest configuration

[global]
repo1-path={{ pgbackrest_repo_path | default((backup_nfs_mount_point | default('/var/lib/pgbackrest')) ~ '/repo1') }}
repo1-retention-full={{ pgbackrest_retention_full | default(7) }}

start-fast=y
process-max={{ pgbackrest_process_max | default(2) }}
log-level-console={{ pgbackrest_log_level_console | default('info') }}

# ---- stanza ----
[{% set stanza = pgbackrest_stanza | default('main') %}{{ stanza }}]

# -----------------------------------------------------------------------------
# PostgreSQL target (physical backup via SSH)
# -----------------------------------------------------------------------------

{% if pgbackrest_pg1_host is defined and (pgbackrest_pg1_host | string | length) > 0 %}
pg1-host={{ pgbackrest_pg1_host }}
{% elif pgbackrest_pg1_host_initial is defined and (pgbackrest_pg1_host_initial | string | length) > 0 %}
pg1-host={{ pgbackrest_pg1_host_initial }}
{% elif (patroni_nodes is defined) and ((patroni_nodes | length) > 0) %}
pg1-host={{ patroni_nodes[0] }}
{% else %}
# ERROR: pgbackrest_pg1_host (or pgbackrest_pg1_host_initial) is undefined.
{% endif %}

pg1-port={{ pg_primary_port | default(pg_vip_port | default(5432)) }}

{% if pg_data_path is defined and (pg_data_path | string | length) > 0 %}
pg1-path={{ pg_data_path }}
{% else %}
pg1-path={{ pg_primary_data_path | default('/var/lib/pgsql/data') }}
{% endif %}

# SSH login user on DB node (OS account for SSH)
pg1-host-user={{ pgbackrest_pg1_host_user | default('root') }}

# PostgreSQL OS/DB user (usually postgres)
pg1-user={{ pg_backup_db_user | default('postgres') }}

# Force SSH identity to prevent wrong key selection
# NOTE: pgBackRest will invoke ssh internally; this makes it deterministic.
{% set key_path = pgbackrest_ssh_key_path | default('/root/.ssh/id_ed25519') %}
pg1-host-config=-i {{ key_path }} -o IdentitiesOnly=yes -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/root/.ssh/known_hosts -o LogLevel=ERROR

