# roles/backup/templates/pgbackrest.conf.j2
# --------------------------------------------------------------------
# Generated by Ansible
# pgBackRest configuration (FOLLOW PRIMARY, NO SSH WRAPPER)
#
# 설계 원칙
# 1. pg1-host-cmd = /usr/bin/ssh (옵션 절대 inline 금지)
# 2. SSH 옵션은 pg1-host-config 파일로만 전달
# 3. primary 는 Ansible 단계에서 Patroni /master로 감지
# 4. dbb(backup node) 에서만 이 파일 사용
# --------------------------------------------------------------------

[global]
repo1-path={{ pgbackrest_repo_path | default('/mnt/pgbackrest') }}
repo1-retention-full={{ retention_full | default(7) }}
start-fast=y
process-max={{ process_max | default(2) }}
log-level-console=info

[main]
# -------------------------------------------------
# FOLLOW PRIMARY
# Patroni /master(HTTP 200) 응답 노드
# -------------------------------------------------
pg1-host={{ pgbackrest_primary_ip }}

# PostgreSQL connection
pg1-port={{ pg_port | default(5432) }}
pg1-path={{ patroni_pg_data_dir | default('/var/lib/pgsql/patroni') }}
pg1-user={{ pgbackrest_pg_user | default('postgres') }}

# -------------------------------------------------
# SSH (CRITICAL SECTION)
# -------------------------------------------------
# ❌ 절대 금지:
#   pg1-host-cmd="/usr/bin/ssh -F ... "
#   pg1-host-cmd="/path/to/wrapper ..."
#
# ✅ 허용:
pg1-host-user=root
pg1-host-cmd=/usr/bin/ssh
pg1-host-config=/etc/pgbackrest/ssh_config
