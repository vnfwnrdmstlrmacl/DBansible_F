#!/usr/bin/env bash
set -euo pipefail

STANZA="{{ pgbackrest_stanza | default('main') }}"
PATRONI_PORT="{{ patroni_rest_port | default(8008) }}"
MASTER_PATH="{{ patroni_master_path | default('/master') }}"

DBA="{{ hostvars['db-a'].ansible_host | default('10.2.3.2') }}"
DBS="{{ hostvars['db-s'].ansible_host | default('10.2.3.3') }}"

die() { echo "[FATAL] $*" >&2; exit 1; }

detect_primary() {
  if curl -fsS --max-time 2 "http://${DBA}:${PATRONI_PORT}${MASTER_PATH}" >/dev/null; then
    echo "${DBA}"
    return 0
  fi
  if curl -fsS --max-time 2 "http://${DBS}:${PATRONI_PORT}${MASTER_PATH}" >/dev/null; then
    echo "${DBS}"
    return 0
  fi
  return 1
}

ACTION="${1:-}"
if [[ -z "${ACTION}" ]]; then
  die "Usage: $0 {whoisprimary|stanza-create|check|backup|restore|info} [pgbackrest args...]"
fi
shift || true

case "${ACTION}" in
  whoisprimary)
    PRIMARY="$(detect_primary)" || die "No Patroni primary detected"
    echo "${PRIMARY}"
    ;;

  stanza-create|check|backup|restore|info)
    PRIMARY="$(detect_primary)" || die "No Patroni primary detected"

    exec pgbackrest \
      --stanza="${STANZA}" \
      --pg1-host="${PRIMARY}" \
      --pg1-host-user="root" \
      --pg1-host-cmd="/usr/local/bin/pgbackrest_host_cmd" \
      "${ACTION}" "$@"
    ;;

  *)
    die "Unknown action: ${ACTION}"
    ;;
esac

