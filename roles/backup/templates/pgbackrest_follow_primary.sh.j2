#!/usr/bin/env bash
set -euo pipefail

STANZA="{{ pgbackrest_stanza }}"
CONF="/etc/pgbackrest/pgbackrest.conf"
LOG="/var/log/pgbackrest/follow_primary.log"

PATRONI_PORT="{{ patroni_rest_port | default(8008) }}"
MASTER_PATH="{{ patroni_master_path | default('/master') }}"

NODES=(
{% for ip in patroni_nodes %}
  "{{ ip }}"
{% endfor %}
)

mkdir -p /var/log/pgbackrest
touch "$LOG"
chmod 0644 "$LOG"

ts() { date '+%F %T'; }

echo "$(ts) INFO: follow-primary run begin" >> "$LOG"

PRIMARY=""
for ip in "${NODES[@]}"; do
  if curl -sSf -o /dev/null --max-time 2 "http://${ip}:${PATRONI_PORT}${MASTER_PATH}"; then
    PRIMARY="$ip"
    break
  fi
done

if [[ -z "$PRIMARY" ]]; then
  echo "$(ts) ERROR: no primary found via Patroni REST (${MASTER_PATH})" >> "$LOG"
  exit 2
fi

if [[ ! -f "$CONF" ]]; then
  echo "$(ts) ERROR: missing config: $CONF" >> "$LOG"
  exit 3
fi

CURRENT="$(grep -E '^[[:space:]]*pg1-host[[:space:]]*=' "$CONF" | tail -n 1 | awk -F= '{gsub(/[[:space:]]/,"",$2); print $2}' || true)"

if [[ "$CURRENT" == "$PRIMARY" ]]; then
  echo "$(ts) INFO: primary unchanged (${PRIMARY})" >> "$LOG"
  exit 0
fi

cp -a "$CONF" "${CONF}.bak.$(date +%F_%H%M%S)"

if grep -qE '^[[:space:]]*pg1-host[[:space:]]*=' "$CONF"; then
  sed -i -E "s|^[[:space:]]*pg1-host[[:space:]]*=.*$|pg1-host=${PRIMARY}|g" "$CONF"
else
  printf "pg1-host=%s\n%s" "$PRIMARY" "$(cat "$CONF")" > "${CONF}.tmp" && mv "${CONF}.tmp" "$CONF"
fi

echo "$(ts) INFO: updated pg1-host: ${CURRENT:-<none>} -> ${PRIMARY}" >> "$LOG"

if pgbackrest --stanza="$STANZA" check >> "$LOG" 2>&1; then
  echo "$(ts) INFO: pgbackrest check OK (primary=${PRIMARY})" >> "$LOG"
  exit 0
else
  echo "$(ts) ERROR: pgbackrest check FAILED after update (primary=${PRIMARY})" >> "$LOG"
  exit 4
fi

