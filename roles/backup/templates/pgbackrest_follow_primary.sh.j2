#!/usr/bin/env bash
set -euo pipefail

STANZA="{{ pgbackrest_stanza }}"
CONF="/etc/pgbackrest/pgbackrest.conf"
LOG="/var/log/pgbackrest/follow_primary.log"

PATRONI_PORT="{{ patroni_rest_port | default(8008) }}"
MASTER_PATH="{{ patroni_master_path | default('/master') }}"

SSH_USER="{{ pgbackrest_pg1_host_user | default('root') }}"
SSH_KEY="{{ pgbackrest_ssh_key_path | default('/root/.ssh/id_ed25519') }}"
SSH_OPTS=(-i "$SSH_KEY" -o IdentitiesOnly=yes -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=/root/.ssh/known_hosts -o LogLevel=ERROR)

NODES=(
{% for ip in patroni_nodes %}
  "{{ ip }}"
{% endfor %}
)

mkdir -p /var/log/pgbackrest
touch "$LOG"
chmod 0644 "$LOG"

ts() { date '+%F %T'; }

echo "$(ts) INFO: follow-primary run begin" >> "$LOG"

PRIMARY=""
for ip in "${NODES[@]}"; do
  if curl -sSf -o /dev/null --max-time 2 "http://${ip}:${PATRONI_PORT}${MASTER_PATH}"; then
    PRIMARY="$ip"
    break
  fi
done

if [[ -z "$PRIMARY" ]]; then
  echo "$(ts) ERROR: no primary found via Patroni REST (${MASTER_PATH})" >> "$LOG"
  exit 2
fi

if [[ ! -f "$CONF" ]]; then
  echo "$(ts) ERROR: missing config: $CONF" >> "$LOG"
  exit 3
fi

# SSH precheck
if ssh "${SSH_OPTS[@]}" "${SSH_USER}@${PRIMARY}" "echo OK" >>"$LOG" 2>&1; then
  echo "$(ts) INFO: SSH precheck OK (${SSH_USER}@${PRIMARY})" >> "$LOG"
else
  echo "$(ts) ERROR: SSH precheck FAILED (${SSH_USER}@${PRIMARY})" >> "$LOG"
  exit 10
fi

CURRENT_HOST="$(grep -E '^[[:space:]]*pg1-host[[:space:]]*=' "$CONF" | tail -n 1 | awk -F= '{gsub(/[[:space:]]/,"",$2); print $2}' || true)"

if [[ "$CURRENT_HOST" == "$PRIMARY" ]]; then
  echo "$(ts) INFO: primary unchanged (${PRIMARY})" >> "$LOG"
  exit 0
fi

cp -a "$CONF" "${CONF}.bak.$(date +%F_%H%M%S)"

# pg1-host update
if grep -qE '^[[:space:]]*pg1-host[[:space:]]*=' "$CONF"; then
  sed -i -E "s|^[[:space:]]*pg1-host[[:space:]]*=.*$|pg1-host=${PRIMARY}|g" "$CONF"
else
  # add under [global] if possible
  if grep -qE '^\[global\]' "$CONF"; then
    awk -v p="pg1-host=${PRIMARY}" '
      BEGIN{done=0}
      /^\[global\]/{print; if(!done){print p; done=1; next}}
      {print}
    ' "$CONF" > "${CONF}.tmp" && mv "${CONF}.tmp" "$CONF"
  else
    printf "pg1-host=%s\n\n%s" "$PRIMARY" "$(cat "$CONF")" > "${CONF}.tmp" && mv "${CONF}.tmp" "$CONF"
  fi
fi

echo "$(ts) INFO: updated pg1-host: ${CURRENT_HOST:-<none>} -> ${PRIMARY}" >> "$LOG"

# verify pgBackRest
if pgbackrest --stanza="$STANZA" check >> "$LOG" 2>&1; then
  echo "$(ts) INFO: pgbackrest check OK (primary=${PRIMARY})" >> "$LOG"
  exit 0
else
  echo "$(ts) ERROR: pgbackrest check FAILED after update (primary=${PRIMARY})" >> "$LOG"
  exit 4
fi

