---
# Patroni REST API로 role 확인 (psql 불필요)
# - primary: /primary 200
# - replica: /replica 200

- name: Check Patroni role via REST API (primary?)
  ansible.builtin.uri:
    url: "http://127.0.0.1:8008/primary"
    method: GET
    return_content: false
    status_code: [200, 503, 404]
  register: patroni_primary_check
  changed_when: false
  failed_when: false

- name: Set patroni_is_primary fact
  ansible.builtin.set_fact:
    patroni_is_primary: "{{ patroni_primary_check.status == 200 }}"

- name: Debug primary detection
  ansible.builtin.debug:
    msg:
      - "Host={{ inventory_hostname }}"
      - "patroni_is_primary={{ patroni_is_primary }}"
      - "HTTP_status={{ patroni_primary_check.status }}"

