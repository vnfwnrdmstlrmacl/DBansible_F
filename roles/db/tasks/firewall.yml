---
# ============================================================
# firewalld 기본 준비
# ============================================================
- name: Ensure firewalld installed
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: Ensure firewalld running
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true

# ============================================================
# 실제 적용 중인 ACTIVE zone 탐지
# (default zone 말고, 인터페이스가 붙은 zone 사용)
# ============================================================
- name: Detect active firewalld zone
  ansible.builtin.shell: |
    set -e
    firewall-cmd --get-active-zones | awk '
      /^[a-zA-Z0-9_-]+$/ {zone=$1}
      /interfaces:/ {print zone; exit}
    '
  register: fw_active_zone
  changed_when: false

- name: Fallback to default zone if active zone not detected
  ansible.builtin.command: firewall-cmd --get-default-zone
  register: fw_default_zone
  changed_when: false
  when: fw_active_zone.stdout | trim == ""

- name: Set firewall zone fact
  ansible.builtin.set_fact:
    fw_zone: >-
      {{
        (fw_active_zone.stdout | trim)
        if (fw_active_zone.stdout | trim) != ""
        else (fw_default_zone.stdout | trim)
      }}

# ============================================================
# DB 노드 전용: PostgreSQL / Patroni 인바운드 허용
# ============================================================
- name: Allow PostgreSQL/Patroni ports on DB nodes
  ansible.posix.firewalld:
    zone: "{{ fw_zone }}"
    rich_rule: >-
      rule family="ipv4"
      source address="{{ item.1 }}"
      port port="{{ item.0.port }}" protocol="{{ item.0.proto }}"
      accept
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ db_firewall_ports | subelements('sources') }}"
  loop_control:
    label: "{{ item.0.desc }} {{ item.0.port }}/{{ item.0.proto }} from {{ item.1 }}"
  when: "'db' in group_names"

# ============================================================
# ETCD 노드 전용: etcd client / peer 포트 허용
# ============================================================
- name: Allow etcd ports on etcd nodes
  ansible.posix.firewalld:
    zone: "{{ fw_zone }}"
    rich_rule: >-
      rule family="ipv4"
      source address="{{ item.1 }}"
      port port="{{ item.0.port }}" protocol="{{ item.0.proto }}"
      accept
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ db_firewall_etcd_ports | subelements('sources') }}"
  loop_control:
    label: "{{ item.0.desc }} {{ item.0.port }}/{{ item.0.proto }} from {{ item.1 }}"
  when: "'etcd' in group_names"

# ============================================================
# (선택) NFS 인바운드 — 기본 OFF
# ============================================================
- name: Allow NFSv4 port 2049 from DB subnet (optional)
  ansible.posix.firewalld:
    zone: "{{ fw_zone }}"
    rich_rule: >-
      rule family="ipv4"
      source address="{{ db_subnet_cidr }}"
      port port="2049" protocol="tcp"
      accept
    permanent: true
    immediate: true
    state: enabled
  when: false

# ============================================================
# DEBUG 출력 (실제 적용 확인용)
# ============================================================
- name: Show active firewalld zones (debug)
  ansible.builtin.command: firewall-cmd --get-active-zones
  register: fw_active_dump
  changed_when: false

- name: Show firewalld rules for selected zone (debug)
  ansible.builtin.command: firewall-cmd --zone={{ fw_zone }} --list-all
  register: fw_list_all
  changed_when: false

- name: Print firewalld debug info
  ansible.builtin.debug:
    msg:
      - "Selected firewall zone: {{ fw_zone }}"
      - "{{ fw_active_dump.stdout }}"
      - "{{ fw_list_all.stdout }}"

