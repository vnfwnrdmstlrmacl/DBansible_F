---
- name: Install PostgreSQL server packages
  dnf:
    name:
      - postgresql-server
      - postgresql
    state: present

- name: Ensure postgres service stopped before Patroni manages it
  service:
    name: postgresql
    state: stopped
    enabled: false
  ignore_errors: true

# ================================
# PostgreSQL runtime preparation
# ================================

- name: Create PostgreSQL data directory for Patroni
  file:
    path: "{{ patroni_pg_data_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0700'

- name: Create PostgreSQL log directory
  file:
    path: "{{ patroni_pg_log_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Check if PostgreSQL data directory already initialized
  stat:
    path: "{{ patroni_pg_data_dir }}/PG_VERSION"
  register: pgdata_initialized

- name: Initialize PostgreSQL database (initdb)
  command: >
    /usr/bin/initdb
    -D {{ patroni_pg_data_dir }}
    --encoding=UTF8
    --locale=C
  become: true
  become_user: postgres
  when:
    - inventory_hostname == 'db-a'
    - not pgdata_initialized.stat.exists

# --------------------------------------------------------------
# DB-S (Replica)를 위한 복제 인증 파일 생성
# --------------------------------------------------------------
- name: Create .pgpass file for replication (Slave only)
  ansible.builtin.template:
    src: pgpass.j2
    dest: /var/lib/pgsql/pgpass
    owner: postgres
    group: postgres
    mode: '0600'
  when: inventory_hostname == 'db-s'
