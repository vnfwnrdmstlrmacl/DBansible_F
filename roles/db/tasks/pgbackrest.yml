---
# roles/db/tasks/pgbackrest.yml
# NOTE: pgBackRest config/ssh handling is managed by roles/backup.
# This file only installs packages and mounts NFS on db-b, and does NOT overwrite /etc/pgbackrest/pgbackrest.conf.

- name: Install base packages for backup (db-b only)
  ansible.builtin.dnf:
    name:
      - nfs-utils
      - curl
      - ca-certificates
      - dnf-plugins-core
    state: present
  when: inventory_hostname == 'db-b'

- name: Enable CRB repo (db-b only)
  ansible.builtin.command: dnf config-manager --set-enabled crb
  register: crb_enable
  changed_when: false
  failed_when: false
  when: inventory_hostname == 'db-b'

- name: Install EPEL release (db-b only)
  ansible.builtin.dnf:
    name: epel-release
    state: present
  when: inventory_hostname == 'db-b'

- name: Refresh dnf cache (db-b only)
  ansible.builtin.dnf:
    update_cache: true
  when: inventory_hostname == 'db-b'

- name: Try install pgBackRest from current repos (db-b only)
  ansible.builtin.dnf:
    name:
      - pgbackrest
    state: present
  register: pgbr_try
  failed_when: false
  when: inventory_hostname == 'db-b'

- name: Install PGDG repo rpm if pgBackRest not available (db-b only)
  ansible.builtin.dnf:
    name: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
    state: present
    disable_gpg_check: true
  when:
    - inventory_hostname == 'db-b'
    - pgbr_try is failed or ('No package pgbackrest available' in (pgbr_try.msg | default('')))

- name: Refresh dnf cache after PGDG repo (db-b only)
  ansible.builtin.dnf:
    update_cache: true
  when:
    - inventory_hostname == 'db-b'
    - pgbr_try is failed or ('No package pgbackrest available' in (pgbr_try.msg | default('')))

- name: Install pgBackRest from PGDG (db-b only)
  ansible.builtin.dnf:
    name:
      - pgbackrest
    state: present
  when:
    - inventory_hostname == 'db-b'
    - pgbr_try is failed or ('No package pgbackrest available' in (pgbr_try.msg | default('')))

- name: Verify mount.nfs helper exists (db-b only)
  ansible.builtin.stat:
    path: /sbin/mount.nfs
  register: mount_nfs_helper
  changed_when: false
  when: inventory_hostname == 'db-b'

- name: Fail if NFS helper missing (db-b only)
  ansible.builtin.fail:
    msg: "NFS mount helper /sbin/mount.nfs not found. nfs-utils must be installed successfully."
  when:
    - inventory_hostname == 'db-b'
    - not mount_nfs_helper.stat.exists

- name: Create mount point (db-b only)
  ansible.builtin.file:
    path: "{{ nfs_mount }}"
    state: directory
    mode: "0755"
  when: inventory_hostname == 'db-b'

- name: Mount NFS repo (db-b only)
  ansible.builtin.mount:
    path: "{{ nfs_mount }}"
    src: "{{ nfs_server }}:{{ nfs_export }}"
    fstype: nfs
    opts: "rw,_netdev,vers=4.1"
    state: mounted
  when: inventory_hostname == 'db-b'

# DO NOT render /etc/pgbackrest/pgbackrest.conf here.
# roles/backup is the single source of truth for pgBackRest config.

- name: Configure cron for full backup (db-b only)
  ansible.builtin.cron:
    name: "pgBackRest Full Backup"
    minute: "0"
    hour: "1"
    job: "pgbackrest --stanza={{ pgbackrest_stanza | default('main') }} --type=full backup"
  when: inventory_hostname == 'db-b'
