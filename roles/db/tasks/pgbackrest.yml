---
# db-b 전용: pgBackRest + NFS repo mount + 스케줄

- name: Install repo helper packages (db-b only)
  ansible.builtin.dnf:
    name:
      - dnf-plugins-core
    state: present
  when: inventory_hostname == 'db-b'

# EL9 계열에서 EPEL 패키지 의존성 때문에 CRB가 필요한 경우가 많음
- name: Enable CRB repo (db-b only)
  ansible.builtin.command: dnf config-manager --set-enabled crb
  register: crb_enable
  changed_when: "'enabled' in (crb_enable.stdout | lower) or crb_enable.rc == 0"
  failed_when: false
  when: inventory_hostname == 'db-b'

- name: Install EPEL release (db-b only)
  ansible.builtin.dnf:
    name: epel-release
    state: present
  when: inventory_hostname == 'db-b'

- name: Refresh dnf cache (db-b only)
  ansible.builtin.dnf:
    update_cache: true
  when: inventory_hostname == 'db-b'

- name: Install pgBackRest and NFS utilities (db-b only)
  ansible.builtin.dnf:
    name:
      - nfs-utils
      - pgbackrest
    state: present
  when: inventory_hostname == 'db-b'

- name: Create mount point (db-b only)
  ansible.builtin.file:
    path: "{{ nfs_mount }}"
    state: directory
    mode: "0755"
  when: inventory_hostname == 'db-b'

- name: Mount NFS repo (db-b only)
  ansible.builtin.mount:
    path: "{{ nfs_mount }}"
    src: "{{ nfs_server }}:{{ nfs_export }}"
    fstype: nfs
    opts: "rw,_netdev"
    state: mounted
  when: inventory_hostname == 'db-b'

- name: Render pgbackrest config (db-b only)
  ansible.builtin.template:
    src: pgbackrest.conf.j2
    dest: /etc/pgbackrest/pgbackrest.conf
    mode: "0644"
  when: inventory_hostname == 'db-b'

# 예: 매일 01:00 full backup (cron)
- name: Configure cron for full backup (db-b only)
  ansible.builtin.cron:
    name: "pgBackRest Full Backup"
    minute: "0"
    hour: "1"
    job: "pgbackrest --stanza=main --type=full backup"
  when: inventory_hostname == 'db-b'

