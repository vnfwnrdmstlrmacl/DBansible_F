# Generated by Ansible (iptables-services)
# external iface: {{ proxy_external_iface }}
# internal iface: {{ proxy_internal_iface }}
# internal cidr : {{ proxy_internal_cidr }}

*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow loopback
-A INPUT -i lo -j ACCEPT

# Allow established/related
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# (옵션) SSH 허용 (원격 운영용)
-A INPUT -p tcp --dport 22 -j ACCEPT

# ICMP 허용 (ping 테스트용)
-A INPUT -p icmp -j ACCEPT

# =========================
# Forwarding rules
# =========================

# 내부 -> 외부 허용
-A FORWARD -i {{ proxy_internal_iface }} -o {{ proxy_external_iface }} -s {{ proxy_internal_cidr }} -j ACCEPT

# 외부 -> 내부(세션 응답) 허용
-A FORWARD -i {{ proxy_external_iface }} -o {{ proxy_internal_iface }} -d {{ proxy_internal_cidr }} -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# --------------------------------------------------------------------
# [추가] DB(10.2.3.0/24) <-> Storage(10.2.2.0/24) 예외 허용
# - 목적: DB subnet의 host(dbb 등)에서 storageVM(10.2.2.30) NFS(2049), rpcbind(111) 접근
# - 현재 증상: dbb -> storageVM ping/2049/111 타임아웃
# - 해결: FORWARD 양방향 명시 허용 (DROP 정책 우회)
# --------------------------------------------------------------------
-A FORWARD -s 10.2.3.0/24 -d 10.2.2.0/24 -j ACCEPT
-A FORWARD -s 10.2.2.0/24 -d 10.2.3.0/24 -j ACCEPT

COMMIT

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# =========================
# NAT (MASQUERADE)
# =========================
-A POSTROUTING -s {{ proxy_internal_cidr }} -o {{ proxy_external_iface }} -j MASQUERADE

# --------------------------------------------------------------------
# [추가] DB -> Storage 전용 MASQUERADE
# - 목적: storageVM이 10.2.3.0/24로 돌아가는 라우트가 없어도 응답이 Proxy로 돌아오도록 SNAT
# --------------------------------------------------------------------
-A POSTROUTING -s 10.2.3.0/24 -d 10.2.2.0/24 -o {{ proxy_external_iface }} -j MASQUERADE

COMMIT

