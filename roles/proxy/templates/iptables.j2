# Generated by Ansible (iptables-services)
# external iface: {{ proxy_external_iface }}
# internal iface: {{ proxy_internal_iface }}
# internal cidr : {{ proxy_internal_cidr }}

*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow loopback
-A INPUT -i lo -j ACCEPT

# Allow established/related
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# (옵션) SSH 허용 (원격 운영용)
-A INPUT -p tcp --dport 22 -j ACCEPT

# ICMP 허용 (ping 테스트용)
-A INPUT -p icmp -j ACCEPT

# =========================
# Forwarding rules
# =========================

# 내부 -> 외부 허용
-A FORWARD -i {{ proxy_internal_iface }} -o {{ proxy_external_iface }} -s {{ proxy_internal_cidr }} -j ACCEPT

# 외부 -> 내부(세션 응답) 허용
-A FORWARD -i {{ proxy_external_iface }} -o {{ proxy_internal_iface }} -d {{ proxy_internal_cidr }} -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

COMMIT

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# =========================
# NAT (MASQUERADE)
# =========================
-A POSTROUTING -s {{ proxy_internal_cidr }} -o {{ proxy_external_iface }} -j MASQUERADE

COMMIT

